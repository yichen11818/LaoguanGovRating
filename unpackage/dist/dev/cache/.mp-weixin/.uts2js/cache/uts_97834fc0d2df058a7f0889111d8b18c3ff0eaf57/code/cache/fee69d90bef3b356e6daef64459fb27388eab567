{"code":"import { defineComponent } from \"vue\";\nexport default defineComponent({\n    data() {\n        return {\n            tableId: '',\n            table: new UTSJSONObject({}),\n            subjects: [],\n            currentSubjectIndex: 0,\n            currentSubject: new UTSJSONObject({}),\n            scores: [],\n            comment: '',\n            existingRating: null\n        };\n    },\n    computed: new UTSJSONObject({\n        subjectOptions() {\n            return this.subjects.map(item => {\n                return new UTSJSONObject({\n                    _id: item._id,\n                    name: item.name,\n                    position: item.position,\n                    department: item.department\n                });\n            });\n        }\n    }),\n    onLoad(options) {\n        if (options.tableId) {\n            this.tableId = options.tableId;\n            this.loadTableDetail();\n        }\n        else {\n            uni.showToast({\n                title: '参数错误',\n                icon: 'none'\n            });\n            setTimeout(() => {\n                uni.navigateBack();\n            }, 1500);\n        }\n    },\n    methods: {\n        // 获取评分表类型名称\n        getTableTypeName(type = null) {\n            const typeMap = new UTSJSONObject({\n                1: '(办公室)一般干部评分',\n                2: '(驻村)干部评分',\n                3: '班子评分'\n            });\n            return typeMap[type] || '未知类型';\n        },\n        // 加载评分表详情\n        loadTableDetail() {\n            uni.showLoading({\n                title: '加载中...'\n            });\n            uniCloud.callFunction({\n                name: 'ratingTable',\n                data: new UTSJSONObject({\n                    action: 'getTableDetail',\n                    data: new UTSJSONObject({\n                        tableId: this.tableId\n                    })\n                })\n            }).then(res => {\n                uni.hideLoading();\n                if (res.result.code === 0) {\n                    this.table = res.result.data.table || new UTSJSONObject({});\n                    this.subjects = res.result.data.subjects || [];\n                    // 初始化评分项\n                    this.initScores();\n                    // 如果有考核对象，默认选择第一个\n                    if (this.subjects.length > 0) {\n                        this.currentSubject = this.subjects[0];\n                        this.loadExistingRating();\n                    }\n                }\n                else {\n                    uni.showToast({\n                        title: res.result.msg || '加载失败',\n                        icon: 'none'\n                    });\n                }\n            }).catch((err = null) => {\n                uni.hideLoading();\n                uni.__f__('error', 'at pages/rater/rating/rating.vue:145', err);\n                uni.showToast({\n                    title: '加载失败，请检查网络',\n                    icon: 'none'\n                });\n            });\n        },\n        // 初始化评分项\n        initScores() {\n            if (this.table.items && this.table.items.length > 0) {\n                this.scores = this.table.items.map((item = null) => {\n                    return new UTSJSONObject({\n                        item_id: item._id || '',\n                        name: item.name,\n                        score: 0,\n                        maxScore: item.maxScore\n                    });\n                });\n            }\n        },\n        // 处理考核对象选择变化\n        handleSubjectChange(e = null) {\n            const index = e.detail.value;\n            this.currentSubjectIndex = index;\n            this.currentSubject = this.subjects[index];\n            // 重置评分\n            this.initScores();\n            this.comment = '';\n            // 加载已有评分记录\n            this.loadExistingRating();\n        },\n        // 加载已有评分记录\n        loadExistingRating() {\n            const userInfo = uni.getStorageSync('userInfo') || new UTSJSONObject({});\n            uniCloud.callFunction({\n                name: 'rating',\n                data: new UTSJSONObject({\n                    action: 'getRatingBySubject',\n                    data: new UTSJSONObject({\n                        table_id: this.tableId,\n                        subject: this.currentSubject.name\n                    })\n                })\n            }).then(res => {\n                if (res.result.code === 0 && res.result.data) {\n                    this.existingRating = res.result.data.rating;\n                    // 填充已有评分\n                    if (this.existingRating) {\n                        this.comment = this.existingRating.comment || '';\n                        // 更新评分项分数\n                        if (this.existingRating.scores && this.existingRating.scores.length > 0) {\n                            this.existingRating.scores.forEach((score = null, index = null) => {\n                                if (index < this.scores.length) {\n                                    this.scores[index].score = score.score;\n                                }\n                            });\n                        }\n                    }\n                }\n            });\n        },\n        // 处理评分变化\n        handleScoreChange(e = null, index = null) {\n            const score = e.detail.value;\n            if (index < this.scores.length) {\n                this.scores[index].score = score;\n            }\n        },\n        // 计算总分\n        calculateTotalScore() {\n            let total = 0;\n            this.scores.forEach(item => {\n                total += parseInt(item.score || 0);\n            });\n            return total;\n        },\n        // 计算最高分\n        calculateMaxScore() {\n            let max = 0;\n            this.scores.forEach(item => {\n                max += parseInt(item.maxScore || 0);\n            });\n            return max;\n        },\n        // 提交评分\n        handleSubmit() {\n            if (!this.currentSubject._id) {\n                uni.showToast({\n                    title: '请选择考核对象',\n                    icon: 'none'\n                });\n                return null;\n            }\n            // 验证分数\n            let valid = true;\n            this.scores.forEach(item => {\n                if (item.score < 0 || item.score > item.maxScore) {\n                    valid = false;\n                }\n            });\n            if (!valid) {\n                uni.showToast({\n                    title: '评分不能超出范围',\n                    icon: 'none'\n                });\n                return null;\n            }\n            uni.showLoading({\n                title: '提交中...'\n            });\n            const userInfo = uni.getStorageSync('userInfo') || new UTSJSONObject({});\n            uniCloud.callFunction({\n                name: 'rating',\n                data: new UTSJSONObject({\n                    action: 'submitRating',\n                    data: new UTSJSONObject({\n                        table_id: this.tableId,\n                        rater: userInfo.username,\n                        subject: this.currentSubject.name,\n                        scores: this.scores,\n                        comment: this.comment\n                    })\n                })\n            }).then(res => {\n                uni.hideLoading();\n                if (res.result.code === 0) {\n                    uni.showToast({\n                        title: '评分提交成功',\n                        icon: 'success'\n                    });\n                    // 更新评分记录\n                    this.existingRating = {\n                        _id: res.result.data.id,\n                        table_id: this.tableId,\n                        rater: userInfo.username,\n                        subject: this.currentSubject.name,\n                        scores: this.scores,\n                        comment: this.comment,\n                        total_score: this.calculateTotalScore()\n                    };\n                }\n                else {\n                    uni.showToast({\n                        title: res.result.msg || '提交失败',\n                        icon: 'none'\n                    });\n                }\n            }).catch((err = null) => {\n                uni.hideLoading();\n                uni.__f__('error', 'at pages/rater/rating/rating.vue:312', err);\n                uni.showToast({\n                    title: '提交失败，请检查网络',\n                    icon: 'none'\n                });\n            });\n        }\n    }\n});\n//# sourceMappingURL=C:/Users/11818/Documents/laoguan/laoguan/pages/rater/rating/rating.vue?vue&type=script&lang.uts.js.map","references":[],"uniExtApis":["uni.showToast","uni.navigateBack","uni.showLoading","uniCloud.callFunction","uni.hideLoading","uni.__f__","uni.getStorageSync"],"map":"{\"version\":3,\"file\":\"rating.vue?vue&type=script&lang.uts.js\",\"sourceRoot\":\"\",\"sources\":[\"rating.vue?vue&type=script&lang.uts\"],\"names\":[],\"mappings\":\"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\"}"}
